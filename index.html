<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Rad van Fortuin Namenkiezer</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #000000;
            color: #ffffff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        #app {
            display: flex;
            flex-direction: row;
            height: 100vh;
            box-sizing: border-box;
            padding: 16px;
            gap: 16px;
        }

        .left-panel {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }

        #wheelCanvas {
            background: #000000;
            display: block;
            max-width: 100%;
        }

        #winnerDisplay {
            margin-top: 16px;
            font-size: 6rem;
            text-align: center;
            min-height: 1.2em;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #444444;
            background: #111111;
            box-sizing: border-box;
            width: 100%;
            max-width: 900px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .spin-main {
            margin-top: 16px;
            padding: 14px 24px;
            font-size: 1.2rem;
            font-weight: 600;
            width: 260px;
            max-width: 80%;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #2d7dd2;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(45, 125, 210, 0.7);
            transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
        }

        .spin-main:hover {
            background: #2564a8;
            box-shadow: 0 0 26px rgba(45, 125, 210, 0.9);
        }

        .spin-main:active {
            transform: scale(0.97);
            box-shadow: 0 0 14px rgba(45, 125, 210, 0.7);
        }

        .controls {
            width: 260px;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-left: 1px solid #333333;
            padding-left: 16px;
        }

        .controls h2 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
        }

        .control-group {
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 10px;
            background: #111111;
        }

        .control-group label {
            font-size: 0.9rem;
            display: block;
            margin-bottom: 4px;
        }

        .control-group input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #444444;
            background: #222222;
            color: #ffffff;
        }

        .control-group input[type="file"] {
            width: 100%;
            font-size: 0.85rem;
        }

        button {
            width: 100%;
            box-sizing: border-box;
            padding: 8px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            background: #2d7dd2;
            color: #ffffff;
            transition: background 0.15s ease, transform 0.05s ease;
        }

        button:hover {
            background: #2564a8;
        }

        button:active {
            transform: scale(0.97);
        }

        button.secondary {
            background: #444444;
        }

        button.secondary:hover {
            background: #555555;
        }

        select {
            width: 100%;
            box-sizing: border-box;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #444444;
            background: #222222;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .small-note {
            font-size: 0.8rem;
            color: #bbbbbb;
            margin-top: 6px;
        }

        .status-label {
            font-size: 0.85rem;
            margin-top: 4px;
            color: #cccccc;
        }

        @media (max-width: 900px) {
            #app {
                flex-direction: column;
            }
            .controls {
                width: 100%;
                border-left: none;
                border-top: 1px solid #333333;
                padding-left: 0;
                padding-top: 12px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }
            .control-group {
                flex: 1 1 180px;
            }
            #winnerDisplay {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
<div id="app">
    <div class="left-panel">
        <canvas id="wheelCanvas"></canvas>
        <div id="winnerDisplay">Nog geen naam geselecteerd</div>
        <button id="spinButton" class="spin-main">Draaien</button>
    </div>
    <div class="controls">
        <div class="control-group">
            <h2>Instellingen rad</h2>
            <button id="toggleAutoDisableButton" class="secondary">Automatisch uitschakelen: uit</button>
            <button id="toggleSoundButton" class="secondary">Geluid: aan</button>
            <button id="enableAllButton" class="secondary">Alle namen weer actief</button>
            <div class="status-label" id="statusText">Namen: 0, actief: 0</div>
        </div>

        <div class="control-group">
            <h2>Namen laden</h2>
            <label for="fileInput">Tekstbestand met namen (.txt)</label>
            <input type="file" id="fileInput" accept=".txt,text/plain">
            <div class="small-note">
                Gebruik een .txt bestand met per regel één naam.
            </div>
        </div>

        <div class="control-group">
            <h2>Naam toevoegen</h2>
            <label for="newNameInput">Nieuwe naam</label>
            <input type="text" id="newNameInput" placeholder="Typ een naam">
            <button id="addNameButton">Naam toevoegen aan rad</button>
        </div>

        <div class="control-group">
            <h2>Rad opslaan en laden</h2>
            <button id="saveWheelButton">Huidig rad opslaan</button>
            <label for="savedWheelsSelect">Bewaarde raderen</label>
            <select id="savedWheelsSelect">
                <option value="">Geen rad geselecteerd</option>
            </select>
            <button id="loadWheelButton" class="secondary">Geselecteerd rad laden</button>
            <div class="small-note">
                Raderen worden opgeslagen in deze browser op dit apparaat.
            </div>
        </div>

        <div class="control-group">
            <h2>Uitleg</h2>
            <div class="small-note">
                Klik op een partje om een persoon uit of aan te zetten.  
                Grijze partjes worden niet meer gekozen.  
                Met automatisch uitschakelen worden gekozen namen na het draaien automatisch uitgeschakeld.  
                Je kunt ook op Enter drukken om het rad te draaien.
            </div>
        </div>
    </div>
</div>

<script>
    // Globale toestand
    let names = []; // array van { name: string, disabled: boolean }
    let rotation = 0; // huidige rotatie in radialen
    let isSpinning = false;
    let soundEnabled = true;
    let autoDisable = false;

    let canvas, ctx;
    let centerX = 0;
    let centerY = 0;
    let radius = 0;

    let lastIndexAtPointer = -1;

    // Audio voor ratelgeluid en gong
    let audioCtx = null;

    function initAudioContext() {
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.warn("AudioContext niet beschikbaar", e);
                audioCtx = null;
            }
        }
    }

    // Ratel per partje
    function playTickSound() {
        if (!soundEnabled) return;
        if (!audioCtx) {
            initAudioContext();
            if (!audioCtx) {
                return;
            }
        }

        const duration = 0.06;
        const sampleRate = audioCtx.sampleRate;
        const frameCount = Math.floor(sampleRate * duration);
        const buffer = audioCtx.createBuffer(1, frameCount, sampleRate);
        const data = buffer.getChannelData(0);

        for (let i = 0; i < frameCount; i++) {
            const t = i / frameCount;
            const envelope = Math.pow(1 - t, 3);
            data[i] = (Math.random() * 2 - 1) * envelope * 0.7;
        }

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;

        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.002);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

        source.connect(gain);
        gain.connect(audioCtx.destination);

        source.start();
    }

    // Zachtere gongachtige "plong" bij de winnaar
    function playWinSound() {
        if (!soundEnabled) return;
        if (!audioCtx) {
            initAudioContext();
            if (!audioCtx) {
                return;
            }
        }

        const now = audioCtx.currentTime;
        const duration = 1.2;

        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        // Basisfrequenties voor een warme gongachtige klank
        osc1.type = "sine";
        osc1.frequency.setValueAtTime(520, now);
        osc1.frequency.exponentialRampToValueAtTime(380, now + duration * 0.7);

        osc2.type = "sine";
        osc2.frequency.setValueAtTime(780, now);
        osc2.frequency.exponentialRampToValueAtTime(560, now + duration * 0.7);

        gain.gain.setValueAtTime(0.0, now);
        gain.gain.linearRampToValueAtTime(0.7, now + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

        osc1.connect(gain);
        osc2.connect(gain);
        gain.connect(audioCtx.destination);

        osc1.start(now);
        osc2.start(now);
        osc1.stop(now + duration);
        osc2.stop(now + duration);
    }

    // Canvas grootte aanpassen aan beschikbare ruimte
    function resizeCanvas() {
        const leftPanel = document.querySelector(".left-panel");
        const winnerDisplay = document.getElementById("winnerDisplay");
        const spinButtonEl = document.getElementById("spinButton");

        const panelWidth = leftPanel.clientWidth;
        const panelHeight = leftPanel.clientHeight;

        const reservedHeight = winnerDisplay.offsetHeight + spinButtonEl.offsetHeight + 48;
        const availableHeight = panelHeight - reservedHeight;

        const size = Math.min(panelWidth - 16, availableHeight);
        const safeSize = Math.max(size, 100);

        canvas.width = safeSize;
        canvas.height = safeSize;

        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
        radius = Math.min(centerX, centerY) - 16;

        drawWheel();
    }

    function getActiveNamesCount() {
        return names.filter(n => !n.disabled).length;
    }

    function updateStatusLabel() {
        const statusText = document.getElementById("statusText");
        statusText.textContent = "Namen: " + names.length + ", actief: " + getActiveNamesCount();
    }

    // Rad tekenen
    function drawWheel() {
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (names.length === 0) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2);
            ctx.strokeStyle = "#444444";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = "#666666";
            ctx.font = "16px system-ui";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("Geen namen geladen", 0, 0);
            ctx.restore();

            drawPointer();
            return;
        }

        const segmentCount = names.length;
        const segmentAngle = (Math.PI * 2) / segmentCount;

        ctx.save();
        ctx.translate(centerX, centerY);

        for (let i = 0; i < segmentCount; i++) {
            const nameEntry = names[i];
            const startAngle = i * segmentAngle - segmentAngle / 2 + rotation;
            const endAngle = startAngle + segmentAngle;

            let fillColor;
            if (nameEntry.disabled) {
                fillColor = "#555555";
            } else {
                const hue = (i * 360 / segmentCount) % 360;
                fillColor = "hsl(" + hue + ", 60%, 55%)";
            }

            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.arc(0, 0, radius, startAngle, endAngle);
            ctx.closePath();

            ctx.fillStyle = fillColor;
            ctx.fill();

            ctx.
